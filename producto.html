<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle de producto ‚Äî Nuit Fantome</title>

  <!-- MISMOS CSS DEL INDEX -->
  <link rel="icon" href="assets/img/icono_pag.png" type="image/png">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400&display=swap">

  <!-- Ocultar buscador en detalle + estilos ligeros -->
  <style>
    .busqueda{display:none!important}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .breadcrumb{font-size:.9rem;margin:16px 0;color:#666}
    .breadcrumb a{color:#0366d6;text-decoration:none}
    .product-layout{display:grid;grid-template-columns:1.2fr 1fr;gap:24px;align-items:start}
    .product-media{border:1px solid #e5e5e5;border-radius:12px;padding:12px;background:#fff}
    .product-media .main{width:100%;height:460px;object-fit:cover;border-radius:10px;background:#2f2f2f}
    .thumbs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .thumbs img{width:64px;height:64px;object-fit:cover;border-radius:8px;border:2px solid #ddd;cursor:pointer}
    .product-info h1{margin:0 0 6px}
    .product-price{color:#9c27b0;font-weight:700;font-size:1.2rem;margin:6px 0 14px}
    .qty{display:flex;align-items:center;gap:10px;margin:10px 0}
    .qty input{width:80px;padding:8px;border:1px solid #ccc;border-radius:8px;text-align:center}
    .muted{color:#bbb}
    @media (max-width:900px){.product-layout{grid-template-columns:1fr}}

    /* Chip + bot√≥n */
    .btn-detalle{
      background:linear-gradient(90deg,#7c3aed 0%,#a78bfa 100%);
      color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;
      box-shadow:0 8px 18px rgba(124,58,237,.25);
    }
    #optLabel{background:#f3f0ff;color:#2b2452;border-radius:999px;padding:6px 10px;font-weight:700;display:inline-block}

    /* MODAL Elegir dise√±o */
    .opt-modal{position:fixed;inset:0;display:none;z-index:99999}
    .opt-modal.show{display:flex;align-items:center;justify-content:center}
    .opt-modal .scrim{position:absolute;inset:0;background:rgba(17,16,40,.5);backdrop-filter:blur(2px)}
    .opt-modal .box{position:relative;z-index:1;width:min(720px,92vw);background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;box-shadow:0 20px 40px rgba(30,27,75,.22)}
    .opt-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:10px}
    .opt-btn{border:1px solid #ece7ff;border-radius:12px;background:#fff;cursor:pointer;min-height:96px;padding:10px;font-weight:700;transition:.1s}
    .opt-btn:hover{transform:translateY(-2px);box-shadow:0 12px 20px rgba(30,27,75,.12)}
    .opt-btn.selected{border-color:#a78bfa;box-shadow:0 0 0 3px rgba(124,58,237,.20) inset}

    /* Grids para relacionados y vistos (mismo look que cards) */
    .section-grid{padding:28px 0}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;transition:.15s}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(30,27,75,.10)}
    .card .ph{width:100%;height:180px;object-fit:cover;border-radius:10px}
    .card .title{font-weight:700;color:#2b254a;text-decoration:none;display:block;margin-top:6px}
    .card .price{color:#7c3aed;font-weight:800}
  </style>
</head>
<body>
  <!-- Top bar + Header -->
  <div class="top-bar">
    <div class="info-envios"><span>ENV√çOS GRATIS DESDE $24.990</span></div>
    <div class="derecha-redes-sociales">
      <a href="cambios.html">Cambios o Devoluciones</a>
      <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook-f"></i></a>
      <a href="mailto:contacto@nuitfantome.com"><i class="fas fa-envelope"></i></a>
    </div>
  </div>
  <header>
    <div class="header-superior">
      <div class="logo"><a href="index.html"><img src="./assets/img/logo.png" alt="Logo Nuit Fantome"></a></div>
      <div class="busqueda"></div>
      <div class="usuario-carrito">
        <div class="dropdown">
          <button class="btn-acceder">ACCEDER</button>
          <div class="dropdown-content">
            <a href="login.html">Iniciar Sesi√≥n</a>
            <a href="register.html">Registrarse</a>
          </div>
        </div>
        <a href="carrito.html" style="text-decoration:none">
          <div class="carrito"><i class="bi bi-bag"></i><span class="contador" id="contador">0</span></div>
        </a>
      </div>
    </div>
    <nav class="barra-tareas">
      <ul>
        <li><a href="index.html">INICIO</a></li>
        <li><a href="productos.html" class="active">PRODUCTOS</a></li>
        <li><a href="nosotros.html">NOSOTROS</a></li>
        <li><a href="blogs.html">BLOGS</a></li>
        <li><a href="contacto.html">CONTACTO</a></li>
      </ul>
    </nav>
  </header>

  <!-- CUERPO -->
  <main class="container">
    <div id="bc" class="breadcrumb"></div>
    <section id="detalle" class="product-layout"></section>

    <!-- RELACIONADOS -->
    <section class="section-grid">
      <h3 style="margin:18px 0 10px;color:#fff">Productos relacionados</h3>
      <div id="relacionados" class="cards"></div>
    </section>

    <!-- VISTOS RECIENTEMENTE -->
    <section class="section-grid">
      <h3 style="margin:18px 0 10px;color:#fff">Productos que viste recientemente</h3>
      <div id="vistosGrid" class="cards"></div>
    </section>
  </main>

  <!-- SECCI√ìN FINAL -->
  <section class="final-final">
    <img src="assets/img/fondo_footer.png" alt="Fondo final" class="final-bg">
    <div class="final-contenido">
      <div class="final-logo"><img src="assets/img/logo.png" alt="Logo Nuit Fantome"></div>
      <div class="final-texto">
        <p>Te ayudamos a planificar para lograrlo todo con nuestra papeler√≠a f√≠sica y digital. 
        Sab√≠as que si tu escritorio tiene colores y te gusta, la motivaci√≥n y la productividad llega por s√≠ sola?</p>
      </div>
      <div class="final-redes">
        <div class="siguenos">S√≠guenos</div>
        <div class="iconos-redes">
          <a href="https://instagram.com"><img src="assets/img/logo_instagram.png" alt="Instagram"></a>
          <a href="https://facebook.com"><img src="assets/img/logo_facebook.png" alt="Facebook"></a>
          <a href="mailto:contacto@nuitfantome.com"><img src="assets/img/logo_gmail.png" alt="Email"></a>
        </div>
      </div>
    </div>
  </section>
  <footer class="footer-final">
    <div class="footer-contenido">
      <div class="footer-texto">¬© 2025 Nuit Fantome. Todos los derechos reservados.</div>
      <div class="footer-pagos">
        <img src="assets/img/webpay.png" alt="Webpay">
        <img src="assets/img/transferencia.png" alt="Transferencia bancaria">
        <img src="assets/img/mercado_pago.png" alt="Mercado Pago">
      </div>
    </div>
  </footer>

  <!-- MODAL Elegir dise√±o -->
  <div id="optModal" class="opt-modal" aria-hidden="true">
    <div class="scrim" onclick="closeOptModal()"></div>
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="optTitle" onclick="event.stopPropagation()">
      <h3 id="optTitle" style="margin:0 0 8px">Elige un dise√±o</h3>
      <div id="optGrid" class="opt-grid"></div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button class="btn-detalle" onclick="closeOptModal()">Listo</button>
      </div>
    </div>
  </div>

  <script>
  /* === Cat√°logo (con opciones donde corresponde) === */
  let productos = [
    { id:"org01", categoria:"Organizadores", nombre:"Organizador de escritorio blanco", precio:12990, img:"assets/img/organizador.jpg.avif",
      desc:"Organizador met√°lico con caj√≥n y compartimentos; ideal para notas, l√°pices y clips." },
    { id:"washi01", categoria:"Cintas / Washi", nombre:"Set 5 washi tape ‚Äì colores mixtos", precio:3990, img:"assets/img/washi-mix5.jpg",
      desc:"Pack de 5 cintas washi de colores mixtos; papel de arroz, 15 mm x 5 m c/u." },
    { id:"calc01", categoria:"Calculadoras", nombre:"Calculadora compacta pastel", precio:6990, img:"assets/img/calculadora-pastel.jpg",
      desc:"Calculadora compacta con teclas suaves y dise√±o pastel; pantalla de 12 d√≠gitos.",
      opciones:[{t:"Rosa"},{t:"Lila"},{t:"Celeste"},{t:"Verde"}] },
    { id:"washi02", categoria:"Cintas / Washi", nombre:"Washi tape ilustrada ‚ÄúVida diaria‚Äù", precio:3490, img:"assets/img/washi-vida-diaria.jpg",
      desc:"Washi ilustrada tem√°tica de vida diaria; ideal para diarios y scrap, 15 mm x 5 m.",
      opciones:[{t:"Amarillo"},{t:"Rosa"},{t:"Verde"},{t:"Morado"}] },
    { id:"washi03", categoria:"Cintas / Washi", nombre:"Set de cintas washi ‚Äì tonos pastel", precio:3990, img:"assets/img/washi-set-pastel.jpg",
      desc:"Set de cintas washi en tonos pastel; adhesivo suave sin residuos, perfecto para bullet journal.",
      opciones:[{t:"Pastel 1"},{t:"Pastel 2"},{t:"Pastel 3"},{t:"Pastel 4"}] },
    { id:"cut01", categoria:"Corte", nombre:"C√∫ter mini ‚ÄúPaw‚Äù (patas de gato)", precio:2990, img:"assets/img/cutter-paw.jpg",
      desc:"C√∫ter mini con tapa en forma de pata; hoja retr√°ctil segura para papeler√≠a y paquetes.",
      opciones:[{t:"Rosa"},{t:"Blanco"},{t:"Amarillo"},{t:"Celeste"}] },
    { id:"cua03", categoria:"Cuadernos & Libretas", nombre:"Cuaderno ilustrado A5 ‚Äì Pinturas", precio:4990, img:"assets/img/cuaderno-pinturas.jpg",
      desc:"Cuaderno A5 con ilustraciones; 80 hojas lisas, papel 90 g, tapa dura.",
      opciones:[{t:"Lila"},{t:"Rosa"},{t:"Lavanda"}] },
    { id:"est01", categoria:"Estuches", nombre:"Estuche Sanrio (set 4) ", precio:8990, img:"assets/img/estuche-kuromi.jpg",
      desc:"Estuche Kuromi con compartimentos y cierre resistente; capacidad para 40‚Äì60 √∫tiles.",
      opciones:[{t:"Cinnamoroll"},{t:"My Melody"},{t:"Kuromi"},{t:"Pompompurin"}] },
    { id:"est02", categoria:"Estuches", nombre:"Estuche Sanrio(set 6)", precio:8990, img:"assets/img/estuche-my-melody.jpg",
      desc:"Estuche My Melody con el√°sticos y bolsillo interno; materiales lavables y durables.",
      opciones:[{t:"My Melody"},{t:"Cinnamoroll"},{t:"Pompompurin"},{t:"Hello Kitty"},{t:"Gudetama"},{t:"Keroppi"}] },
    { id:"fab01", categoria:"L√°pices de grafito", nombre:"Set l√°pices grafito Faber-Castell", precio:18990, img:"assets/img/faber-castell-set.jpg",
      desc:"Set de l√°pices de grafito Faber-Castell (HB‚Äì2B); incluye borrador y sacapuntas." },
    { id:"gom02", categoria:"Borradores", nombre:"Borrador el√©ctrico recargable", precio:11990, img:"assets/img/goma-electrica.jpg",
      desc:"Borrador el√©ctrico recargable por USB; elimina trazos finos sin da√±ar el papel." },
    { id:"gom01", categoria:"Borradores", nombre:"Borradores degrad√© (pack 3)", precio:1990, img:"assets/img/gomas-de-colores.jpg",
      desc:"Pack de 3 gomas degrad√© libres de l√°tex; borra limpio y sin manchas.",
      opciones:[{t:"Verde/Azul"},{t:"Rosa/Celeste"},{t:"Mix pastel"}] },
    { id:"lap10", categoria:"L√°pices de colores", nombre:"Set l√°pices de colores ‚Äì 10 unidades", precio:3990, img:"assets/img/lapices-10.jpg",
      desc:"Set de 10 l√°pices de color de mina suave; trazo cremoso y colores vibrantes." },
    { id:"lap25", categoria:"L√°pices de colores", nombre:"Set l√°pices de colores ‚Äì 25 unidades", precio:7990, img:"assets/img/lapices-25.jpg",
      desc:"Set de 25 l√°pices de color; minas resistentes y mezclables, ideal para ilustraci√≥n." },
    { id:"lap30", categoria:"L√°pices de colores", nombre:"Set l√°pices de colores ‚Äì 30 unidades", precio:20000, img:"assets/img/lapices-30.jpg",
      desc:"Set de 30 l√°pices de color; incluye tonos piel y pasteles, estuche r√≠gido." },
    { id:"pinc01", categoria:"Pinceles / Acuarela", nombre:"Pinceles para acuarela (pack)", precio:8990, img:"assets/img/pinceles-acuarelas.jpg",
      desc:"Pack de pinceles para acuarela con cerdas sint√©ticas finas y mangos ergon√≥micos." },
    { id:"post01", categoria:"Notas adhesivas", nombre:"Notas adhesivas Cinnamoroll / Pompompurin", precio:2990, img:"assets/img/postit-cinnamoroll-pompompurin.jpg",
      desc:"Notas adhesivas oficiales Sanrio; papel suave que pega y despega sin residuos.",
      opciones:[{t:"Cinnamoroll"},{t:"Pompompurin"}] },
    { id:"post02", categoria:"Notas adhesivas", nombre:"Notas adhesivas Kuromi / My Melody", precio:2990, img:"assets/img/postit-kuromi-mymelody.jpg",
      desc:"Notas adhesivas con 3 dise√±os; perfectas para recordatorios y journaling.",
      opciones:[{t:"Kuromi"},{t:"My Melody"}] },
    { id:"post03", categoria:"Notas adhesivas", nombre:"Notas adhesivas Pochacco / Hello Kitty", precio:2990, img:"assets/img/postit-pochacco-hellokitty.jpg",
      desc:"Notas adhesivas de colores suaves; aprox. 100 hojas por bloc.",
      opciones:[{t:"Pochacco"},{t:"Hello Kitty"}] },
    { id:"saca01", categoria:"Sacapuntas", nombre:"Sacapuntas + borrador 2 en 1", precio:3490, img:"assets/img/sacapuntas-borrador.jpg",
      desc:"Sacapuntas con dep√≥sito y borrador integrado; formato compacto para estuche.",
      opciones:[{t:"Celeste"},{t:"Rosa"},{t:"Lila"},{t:"Verde"}] },
    { id:"bol01", categoria:"Bol√≠grafos", nombre:"Bol√≠grafos Sakura gel (pack)", precio:9990, img:"assets/img/sakura-boligrafos.jpg",
      desc:"Bol√≠grafos Sakura de tinta gel pigmentada; secado r√°pido y punta 0.5 mm." },
    { id:"set02", categoria:"Sets", nombre:"Set papeler√≠a ‚ÄúGato Azul‚Äù", precio:10990, img:"assets/img/set-gato-azul.jpg",
      desc:"Set tem√°tico gato azul: stickers, papeles, notas y accesorios combinados." },
    { id:"set01", categoria:"Sets", nombre:"Set papeler√≠a ‚ÄúGato Rosado‚Äù", precio:10990, img:"assets/img/set-gato-rosado.jpg",
      desc:"Set tem√°tico gato rosado; selecci√≥n coordinada para journaling y scrap." },
    { id:"washi60", categoria:"Cintas / Washi", nombre:"Set 60 washi tapes", precio:16990, img:"assets/img/set60-cintas.jpg",
      desc:"Mega set de 60 washi tapes variados; anchos y patrones mixtos para proyectos creativos." },
    { id:"clip01", categoria:"Clips / Accesorios", nombre:"Clips decorativos ‚ÄúClick‚Äù (pack)", precio:2990, img:"assets/img/set-de-click.jpg",
      desc:"Pack de clips decorativos tipo bot√≥n; pl√°stico resistente, colores surtidos.",
      opciones:[{t:"Lila"},{t:"Menta"},{t:"Celeste"}] },
    { id:"tij01", categoria:"Tijeras", nombre:"Tijeras My Melody", precio:6990, img:"assets/img/tijeras-my-melody.jpg",
      desc:"Tijeras con funda, filo inoxidable y agarre c√≥modo; corte suave.",
      opciones:[{t:"Lila"},{t:"Rosa"},{t:"Celeste"}] },
    { id:"washi04", categoria:"Cintas / Washi", nombre:"Washi tape de flores vintage", precio:3490, img:"assets/img/washi-tape-flores.jpg",
      desc:"Washi tape de flores estilo vintage; ideal para cartas, invitaciones y scrapbooking.",
      opciones:[{t:"Morado"},{t:"Rosa"},{t:"Dorado"}] },

    /* ====== NUEVOS PRODUCTOS DIGITALES ====== */
    { id:"todo-hk", categoria:"Papeler√≠a digital", nombre:"To do list ‚Äî Hello Kitty", precio:1990,
      img:"assets/img/to-do-list-hello-kitty.jpg",
      desc:"To do list imprimible (A4/Letter). Incluye prioridades, tareas, notas, estado de √°nimo y consumo de agua." },
    { id:"todo-kuromi", categoria:"Papeler√≠a digital", nombre:"To do list ‚Äî Kuromi", precio:1990,
      img:"assets/img/to-do-list-kuromi.jpg",
      desc:"To do list imprimible (A4/Letter). Incluye prioridades, tareas, notas, estado de √°nimo y consumo de agua." },
    { id:"todo-sailor", categoria:"Papeler√≠a digital", nombre:"To do list ‚Äî Sailor Moon", precio:1990,
      img:"assets/img/to-do-list-sailor-moon.jpg",
      desc:"To do list imprimible (A4/Letter). Incluye prioridades, tareas, notas, estado de √°nimo y consumo de agua." },
    { id:"plan-hk", categoria:"Papeler√≠a digital", nombre:"Planner semanal ‚Äî Hello Kitty", precio:2990,
      img:"assets/img/planner-semanal-hello-kitty.jpg",
      desc:"Planner semanal imprimible (A4/Letter) con espacio para todos los d√≠as y notas." },
    { id:"plan-kuromi", categoria:"Papeler√≠a digital", nombre:"Planner semanal ‚Äî Kuromi", precio:2990,
      img:"assets/img/planner-semanal-kuromi.jpg",
      desc:"Planner semanal imprimible (A4/Letter) con espacio para todos los d√≠as y notas." },
    { id:"plan-sailor", categoria:"Papeler√≠a digital", nombre:"Planner semanal ‚Äî Sailor Moon", precio:2990,
      img:"assets/img/planner-semanal-sailor-moon.jpg",
      desc:"Planner semanal imprimible (A4/Letter) con espacio para todos los d√≠as y notas." }
  ];

  /* üîÅ Merge con lo que se guard√≥ desde el admin */
  (function(){
    const STORAGE_KEY = 'nf_catalog_custom_v1';
    function loadCustom(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    if (Array.isArray(productos)) {
      const mapa = new Map(productos.map(p => [p.id, p]));
      loadCustom().forEach(p => {
        const cp = { ...p };
        // Normaliza rutas tipo "../assets/..." para esta p√°gina
        if (typeof cp.img === 'string' && cp.img.startsWith('../')) {
          cp.img = cp.img.replace(/^\.\.\//, '');
        }
        mapa.set(cp.id, cp); // admin gana por id
      });
      productos = Array.from(mapa.values());
    }
  })();

  /* === Helpers generales === */
  const $ = s => document.querySelector(s);
  const toCLP = n => n.toLocaleString('es-CL',{style:'currency',currency:'CLP'});
  const CART_KEY='nf_cart', RECENT_KEY='nf_recent';

  const loadCart = () => {
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch(e){ return []; }
  };
  const saveCart = c => { localStorage.setItem(CART_KEY, JSON.stringify(c)); updateCartCount(); };

  function updateCartCount(){
    const el=document.getElementById('contador');
    if(el){ el.textContent = loadCart().reduce((a,b)=>a + (b.qty||0), 0); }
  }

  /* ======== ESPEJO DE STOCK (igual que en carrito) ======== */
  const CATALOG_KEY = 'nf_catalog_custom_v1';
  const deepClone = o => JSON.parse(JSON.stringify(o||{}));
  function loadCustomArr(){ try{ return JSON.parse(localStorage.getItem(CATALOG_KEY)||'[]'); }catch{ return []; } }
  function saveCustomArr(arr){ localStorage.setItem(CATALOG_KEY, JSON.stringify(arr)); }

  // Stock disponible unificado (null = sin control)
  function getUnifiedStockFor(id, optName){
    const p = loadCustomArr().find(x=>x.id===id);
    if(!p) return null;
    if(optName){
      const o = (p.opciones||[]).find(x=>x.t===optName);
      if(o){
        if(typeof o.s === 'number') return o.s;
        if(typeof o.stock === 'number') return o.stock;
      }
      return null;
    }
    if(typeof p.stock === 'number') return p.stock;
    return null;
  }
  // Aplica delta al stock (negativo descuenta; positivo devuelve)
  function persistStockChange(id, opt, delta){
    const arr = loadCustomArr();
    let p = arr.find(x=>x.id===id);
    if(!p){
      const base = deepClone(productos.find(z=>z.id===id)) || { id };
      p = { id, ...base };
      arr.push(p);
    }
    if(opt){
      if(!Array.isArray(p.opciones)) p.opciones = [];
      let oo = p.opciones.find(o=>o.t===opt);
      if(!oo){ oo = { t: opt, s: 0 }; p.opciones.push(oo); }
      oo.s = Math.max(0, Number(oo.s||0) + delta);
    }else{
      p.stock = Math.max(0, Number(p.stock||0) + delta);
    }
    saveCustomArr(arr);
  }

  /* === Recientes === */
  const loadRecent = () => {
    try { return JSON.parse(localStorage.getItem(RECENT_KEY)) || []; }
    catch(e){ return []; }
  };
  const saveRecent = arr => localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
  function addRecentlyViewed(id){
    let arr = loadRecent().filter(x=>x!==id);
    arr.unshift(id);
    if(arr.length>12) arr = arr.slice(0,12);
    saveRecent(arr);
  }

  /* Modal opciones */
  let selectedOpt="", currentProd=null;
  function openOptModal(prodId){
    const p = productos.find(x=>x.id===prodId);
    if(!p || !p.opciones) return;
    currentProd=p; selectedOpt="";
    const grid=document.getElementById('optGrid'); grid.innerHTML='';
    p.opciones.forEach(o=>{
      const b=document.createElement('button');
      b.type='button'; b.className='opt-btn'; b.textContent=o.t;
      b.onclick=()=>{
        selectedOpt=o.t;
        grid.querySelectorAll('.opt-btn').forEach(el=>el.classList.remove('selected'));
        b.classList.add('selected');
        updateOptLabel();
        toggleAddBtn();
        closeOptModal();
      };
      grid.appendChild(b);
    });
    document.getElementById('optModal').classList.add('show');
  }
  function closeOptModal(){ document.getElementById('optModal').classList.remove('show'); }
  function updateOptLabel(){
    const lbl=document.getElementById('optLabel');
    if(lbl) lbl.textContent = selectedOpt ? `Elegido: ${selectedOpt}` : 'Ninguno';
  }
  function toggleAddBtn(){
    const btn = document.querySelector('.product-info .btn-detalle.add-to-cart');
    if(!btn) return;
    const needsOpt = currentProd && currentProd.opciones;
    btn.disabled = needsOpt && !selectedOpt;
    btn.style.opacity = btn.disabled ? .6 : 1;
  }

  /* === A√±adir al carrito con control de stock === */
  function addToCart(id, qty=1, opt=""){
    // si el producto tiene opciones, exigir selecci√≥n
    const prod = productos.find(p=>p.id===id);
    if(prod && prod.opciones && !opt){
      alert('Elige un dise√±o antes de a√±adir al carrito.');
      return;
    }

    qty = Math.max(1, parseInt(qty,10) || 1);

    // verificar stock (null = sin control)
    const disp = getUnifiedStockFor(id, opt||"");
    if(disp !== null && disp <= 0){
      alert('Sin stock disponible para esta variante.');
      return;
    }
    if(disp !== null && qty > disp){
      if(!confirm(`Solo quedan ${disp}. ¬øA√±adir ${disp} al carrito?`)) return;
      qty = disp;
    }

    // a√±adir al carrito
    const c = loadCart();
    const it = c.find(i => i.id===id && (i.opt||"")===opt);
    if(it) it.qty += qty; else c.push({id, qty, opt});
    saveCart(c);

    // descontar espejo de stock
    if(disp !== null) persistStockChange(id, opt||null, -qty);

    updateCartCount();
    alert('Producto a√±adido al carrito' + (opt ? ` (${opt})` : ''));
  }

  /* Render relacionados + vistos */
  function renderRelated(base){
    const wrap = document.getElementById('relacionados'); wrap.innerHTML='';
    let list = productos.filter(p=>p.id!==base.id && p.categoria===base.categoria);
    if(list.length<4) list = [...list, ...productos.filter(p=>p.id!==base.id && p.categoria!==base.categoria)];
    list.slice(0,4).forEach(p=>{
      const a = document.createElement('a');
      a.className='card'; a.href=`producto.html?id=${p.id}`;
      a.innerHTML = `
        ${p.img?`<img class="ph" src="${p.img}" alt="${p.nombre}">`:`<div class="ph"></div>`}
        <div class="title">${p.nombre}</div>
        <div class="price">${toCLP(p.precio)}</div>`;
      wrap.appendChild(a);
    });
  }
  function renderRecentlyViewed(currentId){
    const wrap = document.getElementById('vistosGrid'); wrap.innerHTML='';
    const ids = loadRecent().filter(id=>id!==currentId);
    if(ids.length===0){ wrap.innerHTML='<div class="muted">A√∫n no has visto productos.</div>'; return; }
    ids.slice(0,8).forEach(id=>{
      const p = productos.find(x=>x.id===id); if(!p) return;
      const a = document.createElement('a');
      a.className='card'; a.href=`producto.html?id=${p.id}`;
      a.innerHTML = `
        ${p.img?`<img class="ph" src="${p.img}" alt="${p.nombre}">`:`<div class="ph"></div>`}
        <div class="title">${p.nombre}</div>
        <div class="price">${toCLP(p.precio)}</div>`;
      wrap.appendChild(a);
    });
  }

  /* Detalle */
  const getParam = k => new URLSearchParams(location.search).get(k);
  function renderDetalle(){
    const id = getParam('id');
    const p = productos.find(x=>x.id===id) || productos[0];
    currentProd=p; selectedOpt="";

    // Migas
    document.getElementById('bc').innerHTML =
      `<a href="index.html">Inicio</a> ‚Ä∫ <a href="productos.html">${p.categoria||'Categor√≠a'}</a> ‚Ä∫ <span class="muted">${p.nombre}</span>`;

    // Guardar como visto
    addRecentlyViewed(p.id);

    // Media
    const media = `
      <div class="product-media">
        ${p.img ? `<img class="main" src="${p.img}" alt="${p.nombre}">` : `<div class="main"></div>`}
        <div class="thumbs">
          ${p.img ? `<img src="${p.img}" alt="thumb" onclick="document.querySelector('.main').src='${p.img}'">`:''}
          ${p.img ? `<img src="${p.img}" alt="thumb" onclick="document.querySelector('.main').src='${p.img}'">`:''}
          ${p.img ? `<img src="${p.img}" alt="thumb" onclick="document.querySelector('.main').src='${p.img}'">`:''}
        </div>
      </div>`;

    // Texto ‚ÄúDisponibles‚Äù (si hay control de stock). Si tiene variantes, se actualiza tras elegir.
    const dispTxt = (()=>{
      const d = getUnifiedStockFor(p.id, (p.opciones? (selectedOpt||"") : ""));
      if(d === null) return '';
      return `<div class="muted" id="dispTxt" style="margin:6px 0 10px">Disponibles: ${d}</div>`;
    })();

    // Info
    const info = `
      <div class="product-info">
        <h1>${p.nombre}</h1>
        <div class="product-price">${toCLP(p.precio)}</div>
        ${dispTxt}
        <p class="muted" style="color:#ddd">${p.desc||''}</p>

        ${p.opciones ? `
          <div class="opt-actions" style="display:flex;gap:12px;align-items:center;margin:12px 0">
            <button class="btn-detalle" onclick="openOptModal('${p.id}')">Elegir dise√±o</button>
            <span id="optLabel">Ninguno</span>
          </div>` : ``}

        <div class="qty">
          <label for="qty">Cantidad</label>
          <input id="qty" type="number" min="1" value="1">
        </div>

        <button class="btn-detalle add-to-cart" onclick="addToCart('${p.id}', parseInt(document.getElementById('qty').value)||1, selectedOpt)">A√±adir al carrito</button>
      </div>`;

    document.getElementById('detalle').innerHTML = media + info;

    // Relacionados + Vistos
    renderRelated(p);
    renderRecentlyViewed(p.id);

    updateOptLabel();
    toggleAddBtn();

    // si elige opci√≥n luego, actualizar ‚ÄúDisponibles‚Äù
    const lbl = document.getElementById('optLabel');
    const origUpdate = updateOptLabel;
    updateOptLabel = function(){
      origUpdate();
      const d = getUnifiedStockFor(p.id, selectedOpt||"");
      const el = document.getElementById('dispTxt');
      if(el && d!==null) el.textContent = `Disponibles: ${d}`;
      toggleAddBtn();
    }
  }

  /* Menu desplegable */
  document.addEventListener("DOMContentLoaded", function () {
    const btnAcceder = document.querySelector(".btn-acceder");
    const dropdown = document.querySelector(".dropdown-content");

    btnAcceder.addEventListener("click", function () {
      dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
    });

    // Se cierra el men√∫ si se hace click fuera
    window.addEventListener("click", function (e) {
      if (!e.target.matches(".btn-acceder")) {
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        }
      }
    });
  });

  function actualizarContador() {
    const contador = document.getElementById("contador");
    const total = (loadCart() || []).reduce((acc, it) => acc + (it.qty||0), 0);
    if (contador) contador.textContent = total;
  }

  // Init
  updateCartCount();
  renderDetalle();
  </script>
</body>
</html>

